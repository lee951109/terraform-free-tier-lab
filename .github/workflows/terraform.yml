name: Terraform CI/CD

on:
  pull_request:
    paths:
      - '**.tf'
      - '**.tftpl'
      - '.github/workflows/terraform.yml'
  push:
    branches: [ "master", "main" ]
    paths:
      - '**.tf'
      - '**.tftpl'

permissions:
  id-token: write   # <- OIDC 토큰 발급을 위해 꼭 필요
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  TF_VERSION: ${{ vars.TF_VERSION }}
  TF_IN_AUTOMATION: "true"

jobs:
  fmt-validate-plan:
    name: Fmt / Validate / Plan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.TF_APPLY_ROLE_ARN }}   # ⬅️ 모듈이 만든 Role ARN(변수로 주입)
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init -backend-config=backend.hcl

      - name: Terraform Fmt
        run: terraform fmt -check -recursive

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -out tfplan.out
        continue-on-error: true

      - name: Show Plan (PR용 출력)
        if: github.event_name == 'pull_request'
        run: terraform show -no-color tfplan.out | tail -n 2000

  apply:
    name: Terraform Apply (prod)
    needs: fmt-validate-plan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    environment: prod     # ⬅️ 앞에서 만든 Environment 이름 (승인 필요)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.TF_APPLY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init -backend-config=backend.hcl

      - name: Terraform Apply
        run: terraform apply -auto-approve
